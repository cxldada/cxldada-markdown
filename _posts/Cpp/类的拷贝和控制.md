---
title: 类的拷贝控制
date: 2020-07-02 08:13:25
categories: Cpp
tag: c++
---

# 类的拷贝控制

> 我们可以显式指定对象的拷贝、移动、赋值和销毁。
>
> 通过五个特殊的成员函数来完成：
>
> 1. 拷贝构造函数
> 2. 拷贝赋值运算符
> 3. 移动构造函数
> 4. 移动赋值运算符
> 5. 析构函数
>
> 这五个函数构成了类的拷贝控制操作

拷贝和移动构造函数定义了当用同类型的另一个对象初始化本对象时做什么

拷贝和移动复制运算符定义了将一个对象赋予同类型的另一个对象时做什么

析构函数定义了当此类型对象销毁时做什么

## 拷贝构造函数

> 如果一个构造函数的**第一个参数是自身的引用类型**，且任何额外的参数都有默认值，那么这个构造函数就是拷贝构造函数

编译器合成的拷贝构造函数会从给定对象中一次将每个非static成员拷贝到正在创建的对象中

拷贝初始化发生的情况：

1. 将一个对象作为实参传递给一个非引用类型的形参
2. 从一个返回类型为非引用类型的函数返回一个对象
3. 用花括号列表初始化一个数组中的元素或一个聚合类中的成员
4. 初始化时使用等号(=)赋值的也是拷贝初始化

## 拷贝赋值运算符

> 拷贝复制运算符的定义如下：
>
> ```c++
> class Foo {
> public:
>     Foo &operator=(const Foo&);
> };
> ```

**赋值运算符通常应该返回一个指向起左侧运算对象的引用**

编译器合成的拷贝赋值运算符所做的操作与拷贝构造函数相同

自动调用析构函数的情况：

* 变量在离开其作用域时被销毁
* 当一个对象被销毁时，它的成员被销毁
* 容器被销毁时
* 对动态分配的对象，当对指向它的指针应用delete运算时被销毁
* 对于临时对象，当创建它的完整表达式结束时被销毁

## 限制拷贝的方法

#### 定义删除的函数

定义拷贝构造函数和拷贝赋值运算符函数，在后面加`= delete`

析构函数不能定义为删除的函数

#### 将拷贝控制定义为`private`

## 类的两种拷贝语义

> 1. 类的行为像一个值。当我们拷贝一个像值的对象时，副本和原对象时完全独立的，改变副本不会对原对象有任何影响
> 2. 行为像指针的类。当我们拷贝这种类的对象的时候，副本和原对象使用相同的底层数据。改变副本会改变原对象，反之亦然

当类的行为像一个值的时候，我们在定义拷贝操作的时候一定注意：即使见过一个对象赋于它自身，拷贝操作也能正常工作。最好的方法就是在拷贝前，将右值存到一个临时变量中，再清空左值的成员数据，然后将临时变量赋于左值。

当类的行为像指针时，在析构函数中要注意指针对象的释放工作，只有当最后一个引用被删除时，才能释放掉其所占的内存。一种时使用智能指针，另一种时使用引用计数的方式

## 交换操作

资源管理的类通常还要定一名为`swap`的函数，这可能是一种很重要的优化手段

比较典型的示例代码

```c++
class HasPtr {
    friend void swap(HasPtr &,HasPtr&);
    //其他成员定义
    std::string *ps;
    int i;
};
inline void swap(HasPtr &lhs, HasPtr &rhs) {
    using std::swap;
    swap(lhs.ps,rhs.ps);
    swap(lhs.i,rhs.i);
}
```

## 移动构造函数和移动赋值运算符

> 可以在不分配新空间的情况下进行对象的拷贝和赋值，所以执行的速度也是很快的，属于一种优化方案吧。
>
> 这两个函数的的声明和定义与拷贝构造函数和拷贝赋值运算符一样，只是都换成了同类型的右值引用，函数的声明和定义中最好加上`:noexcept`，表示该函数不会抛出异常。
>
> 在这两个函数的中，一定要记得最后要将右值引用的所有成员变量置于可析构状态。因为右值引用的值是一种即将销毁的状态
>
> 只有当一个类没有定义任何自己版本的拷贝控制函数，且类的所有非static成员都有移动操作的情况下，编译器才会帮我们合成一个默认移动构造函数或移动赋值运算符

当一个类定义了自己的拷贝函数和移动函数，则当表达式的右边是右值引用时会调用移动函数，如果右边是左值引用的话会调用拷贝函数。如果类没有定义移动函数，则都是拷贝函数。

## 三五法则

> 拷贝控制操作的五个成员函数有时候不需要全部定义，但是他们是一个整体。我们可以遵循下面的几个准则来适当的定义就好了

- 需要析构函数的类也需要拷贝和赋值操作
- 需要拷贝操作的类也需要赋值操作，反之亦然
- 当然最好是定义了其中一个的就全部实现，拷贝函数有三个为一组，移动函数有两个为一组